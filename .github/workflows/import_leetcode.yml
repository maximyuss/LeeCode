name: Import from leetcode
on:
  push:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Download LeetCode index
        run: |
          curl -fsSL --retry 3 --retry-delay 2 \
               -H "Referer: https://leetcode.com/" \
               -H "Accept: application/json" \
               --create-dirs -o import/leetcode.json \
               https://leetcode.com/api/problems/all/

      - run: python import/leetcode.py

      - name: Commit changes (reuse last push message)
        env:
          LAST_MSG: ${{ github.event.head_commit.message }}
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "Nothing to commit"
            exit 0
          fi

          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git add -A

          files="$(git diff --cached --name-only)"
          count="$(printf "%s\n" "$files" | sed '/^$/d' | wc -l)"
          msg="${LAST_MSG}"

          if [ -z "$msg" ]; then
            if [ "$count" -eq 1 ]; then
              base="$(basename "$files")"
              msg="Update $base"
            else
              probs="$(printf "%s\n" "$files" \
                | grep -Eo 'code/[^/]+/[0-9]+\.' | grep -Eo '[0-9]+' \
                | sort -n | uniq | paste -sd, -)"
              if [ -n "$probs" ]; then
                msg="Import solution for problems: $probs"
              else
                base="$(printf "%s\n" "$files" | xargs -n1 basename | paste -sd ", " -)"
                msg="Update $base"
              fi
            fi
          fi

          git commit -m "$msg"
          git push
